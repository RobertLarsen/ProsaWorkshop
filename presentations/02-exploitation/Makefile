ASSIGNMENT_C_FILES=$(wildcard assignments/*.c)
ASSIGNMENT_BUG_FILES=$(ASSIGNMENT_C_FILES:.c=.bug)
ASSIGNMENT_PROGRAMS=$(ASSIGNMENT_C_FILES:.c=) $(ASSIGNMENT_C_FILES:.c=_canary) $(ASSIGNMENT_C_FILES:.c=_canary_pie)
SVG_FILES=$(wildcard images/*.svg)
SVG_PNG_FILES=$(SVG_FILES:.svg=.png)
CFLAGS=-m32 -z execstack -Wno-deprecated-declarations 
ASCIIDOC_FLAGS=--attribute duration=240 --attribute data-uri --attribute stylesheet=prosa.css
MAKE_CHROOT=../../scripts/make_chroot.sh

.phony: watch clean all no_presentation

all: index.html no_presentation

no_presentation: $(ASSIGNMENT_PROGRAMS) assignments/root 

index.html: index.asciidoc text/*.asciidoc $(ASSIGNMENT_BUG_FILES) $(SVG_PNG_FILES) $(ASSIGNMENT_C_FILES)
	asciidoc $(ASCIIDOC_FLAGS) --backend slidy2 --out-file=- $< | sed -e '/id="footer"/,+6d' -e 's/next_slide(false/next_slide(true/' -e 's/previous_slide(false/previous_slide(true/' -e 's/key == 188/key == 116 || key == 27/' > $@

images/%.png: images/%.svg
	inkscape --export-area-drawing --export-png=$@ $<

assignments/%: assignments/%.c
	$(CC) $(CFLAGS) -fno-stack-protector -o $@ $<

assignments/%_canary: assignments/%.c
	$(CC) $(CFLAGS) -fstack-protector-all -o $@ $<

assignments/%_canary_pie: assignments/%.c
	$(CC) $(CFLAGS) -fpic -pie -fstack-protector-all -o $@ $<

assignments/%.bug: assignments/%.c
	awk '/STARTS/{flag=1;next}/ENDS/{flag=0}flag' $< > $@

assignments/%.c: assignments/%.gpg
	gpg --passphrase-file passphrase -o $@ $<

assignments/root: assignments/integer_conversion assignments/integer_overflow assignments/integer_conversion_canary assignments/integer_overflow_canary assignments/integer_conversion_canary_pie assignments/integer_overflow_canary_pie
	$(MAKE_CHROOT) $@/ $^ /bin/bash /bin/ls /bin/cat /usr/bin/id
	cp $@/bin/bash $@/bin/sh
	head -c 20 /dev/urandom | md5sum | awk '{print $$1}' > $@/flag

clean:
	rm -rf index.html $(ASSIGNMENT_PROGRAMS) $(ASSIGNMENT_BUG_FILES) assignments/root

watch: all
	wait_for_change Makefile *.asciidoc text/*.asciidoc assignments/*.c | while read f; do rm -f index.html; make; done
